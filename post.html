<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paper-a-Day — Post</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily:{ sans:['Hind Siliguri','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Noto Sans','Ubuntu','Cantarell','Helvetica Neue','Arial','sans-serif'] }, colors: { brand: { 500: '#4f46e5', 600:'#4338ca' } } } } }
  </script>
</head>
<body class="bg-white text-gray-900 font-sans antialiased">
  <header class="sticky top-0 z-10 bg-white/95 border-b">
    <div class="max-w-3xl mx-auto px-5 py-3 flex items-center justify-between">
      <a href="index.html" class="text-2xl font-extrabold tracking-tight text-gray-900">A Paper A Day</a>
      <nav class="text-sm text-gray-600">
        <a href="index.html" class="mr-4 hover:underline">Home</a>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-5 py-10">
    <a href="index.html" class="inline-flex items-center gap-2 text-sm text-gray-700 hover:underline">← Back to posts</a>

    <article id="post" class="mt-6">
      <!-- Post content will be injected here -->
      <div id="loading" class="text-gray-500">Loading post…</div>
    </article>
  </main>

  <footer class="mt-20 border-t bg-white">
    <div class="max-w-3xl mx-auto px-5 py-6 text-sm text-gray-500">Built with Tailwind • Static demo</div>
  </footer>

  <script src="data.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const postEl = document.getElementById('post');

    function formatDate(iso) {
      try { return new Date(iso).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric'}); } catch(e){ return iso; }
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function renderNotFound(){
      postEl.innerHTML = `<div class="text-center py-12">
        <h2 class="text-xl font-semibold">Post not found</h2>
        <p class="text-gray-500 mt-2">We couldn't find a post with id <strong>${escapeHtml(id)}</strong>.</p>
      </div>`;
    }

    if (!Array.isArray(window.posts)){
      postEl.innerHTML = '<div class="p-6 bg-red-50 border border-red-100 text-red-800 rounded">Missing <code>data.js</code> or `window.posts` array.</div>';
    } else {
      const pid = isNaN(Number(id)) ? id : Number(id);
      const p = (window.posts || []).find(x => x.id === pid);
      if (!p) {
        renderNotFound();
      } else {
        // Update SEO meta tags
        document.title = escapeHtml(p.title) + " — Paper-a-Day";
        updateMetaTag('name', 'description', p.excerpt || '');
        updateMetaTag('name', 'keywords', Array.isArray(p.tags) ? p.tags.join(', ') : '');
        updateMetaTag('name', 'author', window.author.name);
        // Open Graph
        updateMetaTag('property', 'og:title', p.title);
        updateMetaTag('property', 'og:description', p.excerpt || '');
        updateMetaTag('property', 'og:url', window.location.href);
        updateMetaTag('property', 'og:type', 'article');
        if (p.date) updateMetaTag('property', 'article:published_time', p.date);
        if (p.image) updateMetaTag('property', 'og:image', p.image);
        // Twitter
        updateMetaTag('name', 'twitter:card', 'summary');
        updateMetaTag('name', 'twitter:title', p.title);
        updateMetaTag('name', 'twitter:description', p.excerpt || '');
        if (p.image) updateMetaTag('name', 'twitter:image', p.image);
        // Canonical link
        if (p.link) {
          let canonical = document.querySelector('link[rel="canonical"]');
          if (!canonical) {
            canonical = document.createElement('link');
            canonical.rel = 'canonical';
            document.head.appendChild(canonical);
          }
          canonical.href = p.link;
        }

        postEl.innerHTML = `
          <header>
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-gray-900">${escapeHtml(p.title)}</h1>
            <div class="mt-3 text-sm text-gray-500 flex items-center gap-2">
              <time>${formatDate(p.date)}</time>
              <span>·</span>
              <span>${readingTime(p)}</span>
            </div>
            <div class="mt-4 flex items-center gap-3">
              <img src="${escapeHtml(window.author.image)}" alt="${escapeHtml(window.author.name)}" class="w-10 h-10 rounded-full">
              <div>
                <div class="font-medium text-gray-900">${escapeHtml(window.author.name)}</div>
                <div class="text-sm text-gray-500">${escapeHtml(window.author.affiliation)}</div>
              </div>
            </div>
          </header>
          ${p.image ? `<img src="${escapeHtml(p.image)}" alt="${escapeHtml(p.title)}" class="w-full max-w-3xl mx-auto aspect-video object-cover rounded-lg mt-8 mb-8">` : ''}
          <div class="mt-8 text-gray-900 leading-8 text-[1.1rem] space-y-6">${p.post ? renderMarkdownLike(p.post) : ''}</div>
          ${p.citation ? `<div class="mt-8 text-sm text-gray-700"><strong class="font-semibold">Citation:</strong> ${renderInlineLinks(p.citation)}</div>` : ''}
          ${Array.isArray(p.tags) && p.tags.length ? `<div class="mt-8 flex flex-wrap gap-2">${p.tags.map(t => `<span class="text-xs bg-slate-100 text-slate-700 px-2.5 py-1 rounded-full border">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
        `;
      }
    }

    // very small markdown-like renderer for paragraphs and line breaks
    function renderMarkdownLike(text){
      const paras = String(text).split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
      return paras.map(p => `<p class="text-[1.05rem]">${escapeHtml(p).replace(/\n/g,'<br>')}</p>`).join('');
    }

    function readingTime(p){
      const text = (p && p.post) ? String(p.post) : '';
      const words = (text.match(/\S+/g)||[]).length;
      const mins = Math.max(1, Math.round(words/200));
      return `${mins} min read`;
    }

    // Render [text](url) as anchors while escaping surrounding text
    function renderInlineLinks(str){
      const text = String(str);
      const linkRe = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
      let lastIndex = 0; let out = '';
      for (const m of text.matchAll(linkRe)){
        out += escapeHtml(text.slice(lastIndex, m.index));
        const label = escapeHtml(m[1]);
        const href = escapeHtml(m[2]);
        out += `<a href="${href}" target="_blank" class="underline decoration-slate-300 hover:decoration-slate-800">${label}</a>`;
        lastIndex = m.index + m[0].length;
      }
      out += escapeHtml(text.slice(lastIndex));
      return out;
    }

    function updateMetaTag(attr, value, content) {
      let meta = document.querySelector(`meta[${attr}="${value}"]`);
      if (!meta) {
        meta = document.createElement('meta');
        meta.setAttribute(attr, value);
        document.head.appendChild(meta);
      }
      meta.setAttribute('content', content);
    }
  </script>
</body>
</html>